<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>あみだくじ（オフライン・スタンドアロン）</title>
  <style>
    html, body { margin:0; padding:0; background:#f8fafc; color:#0f172a; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial, sans-serif; }
    .container { max-width:1000px; margin:24px auto; padding:16px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,.05); padding:16px; }
    .h1 { font-size:22px; font-weight:800; margin:0 0 12px; letter-spacing:.02em; }
    .row { display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; margin-bottom:12px; }
    .label { font-size:12px; margin-bottom:4px; display:block; color:#334155; }
    input[type=number], input[type=text] { border:1px solid #cbd5e1; border-radius:10px; padding:10px 12px; outline:none; font-size:16px; }
    input[type=text] { width:140px; }
    .btn { border:0; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; font-size:16px; }
    .btn-primary { background:#111827; color:#fff; }
    .btn-primary:hover { opacity:.9; }
    .btn-blue { background:#2563eb; color:#fff; }
    .btn-blue:disabled { opacity:.5; cursor:not-allowed; }
    .muted { color:#64748b; font-size:12px; }
    .stage { position:relative; margin-top: 24px; }
    .top-inputs { position:absolute; left:0; right:0; top:8px; display:flex; justify-content:space-between; padding:0 16px; z-index:3; gap: 8px; }
    .top-inputs > div { width: 120px; transform: translateX(-50%); }
    .top-inputs input { background:#fff; width: 120px; }
    .svg-wrap { position:relative; overflow:auto; z-index:1; margin-top: 56px; }
    .win-label { font-weight:700; margin-left: 8px; }
    @media (max-width: 600px) {
      .container { margin: 0 auto; padding: 8px; }
      .top-inputs { top: 6px; padding: 0 8px; }
      .top-inputs > div { width: 100px; }
      .top-inputs input { width: 100px; padding: 8px 10px; }
      .svg-wrap { margin-top: 50px; }
      .h1 { font-size: 20px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1 class="h1">あみだくじ</h1>
      <div class="row">
        <div>
          <label class="label">人数</label>
          <input id="num" type="number" min="2" value="5" />
        </div>
        <button id="gen" class="btn btn-primary">生成</button>
        <button id="reveal" class="btn btn-blue" disabled>結果発表</button>
        <span id="winLabel" class="win-label" style="display:none;"></span>
      </div>
      <p id="hint" class="muted">人数を入力して「生成」を押してください。各列の上で名前を入力できます。</p>
      <div id="stage" class="stage" style="display:none;">
        <div id="inputs" class="top-inputs"></div>
        <div class="svg-wrap">
          <svg id="svg" width="900" height="520" style="background:#fff;border-radius:12px;border:1px solid #e5e7eb"></svg>
        </div>
      </div>
      <div class="muted" style="margin-top:10px;">この版は完全オフラインで動作します（CDN・サーバー不使用）。</div>
    </div>
  </div>

  <script>
    const width = 900, height = 520, topY = 40, bottomY = height - 40;
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

    const state = {
      numPlayers: 5,
      names: [],
      rungs: [],
      colXs: [],
      generated: false,
      revealed: false,
      winBottom: null,
      winnerTop: null,
      paths: []
    };

    function generateRungs(numPlayers, h) {
      const rungs = [];
      const minGap = 28;
      const pairs = numPlayers - 1;
      const baseCount = clamp(Math.round(h / 120), 2, 7);
      for (let p = 0; p < pairs; p++) {
        const count = baseCount + Math.floor(Math.random() * 2);
        const ys = [];
        for (let i = 0; i < count; i++) {
          let tries = 0;
          while (tries < 40) {
            const y = 40 + Math.random() * (h - 80);
            if (ys.every((yy) => Math.abs(yy - y) >= minGap)) {
              const neighborLeft = rungs.filter((r) => r.leftCol === p - 1);
              const neighborRight = rungs.filter((r) => r.leftCol === p + 1);
              const nearNeighbor = [...neighborLeft, ...neighborRight].some((r) => Math.abs(r.y - y) < minGap * 0.7);
              if (!nearNeighbor) { ys.push(y); rungs.push({ leftCol: p, y }); break; }
            }
            tries++;
          }
        }
      }
      rungs.sort((a, b) => a.y - b.y);
      return rungs;
    }

    function tracePath(startCol, rungs, colXs) {
      let col = startCol;
      let y = topY;
      const points = [[colXs[col], y]];
      for (const rung of rungs) {
        if (rung.leftCol === col || rung.leftCol === col - 1) {
          const goingDown = rung.y > y;
          const isOnLeft = rung.leftCol === col;
          const isOnRight = rung.leftCol === col - 1;
          if (goingDown && (isOnLeft || isOnRight)) {
            points.push([colXs[col], rung.y]);
            col = isOnLeft ? col + 1 : col - 1;
            points.push([colXs[col], rung.y]);
            y = rung.y;
          }
        }
      }
      points.push([colXs[col], bottomY]);
      return { points, endCol: col };
    }

    function renderSVG() {
      const svg = document.getElementById('svg');
      svg.innerHTML = '';

      // vertical lines
      state.colXs.forEach((x, i) => {
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', x); line.setAttribute('y1', topY);
        line.setAttribute('x2', x); line.setAttribute('y2', bottomY);
        line.setAttribute('stroke', '#111'); line.setAttribute('stroke-width', '2');
        svg.appendChild(line);

        // top name labels
        const t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        t.setAttribute('x', x); t.setAttribute('y', topY - 10);
        t.setAttribute('text-anchor', 'middle'); t.setAttribute('font-size', '12'); t.setAttribute('fill', '#111');
        t.textContent = state.names[i] || `参加者${i+1}`;
        svg.appendChild(t);
      });

      // rungs
      state.rungs.forEach((r) => {
        const hline = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        hline.setAttribute('x1', state.colXs[r.leftCol]);
        hline.setAttribute('y1', r.y);
        hline.setAttribute('x2', state.colXs[r.leftCol + 1]);
        hline.setAttribute('y2', r.y);
        hline.setAttribute('stroke', '#111'); hline.setAttribute('stroke-width', '3');
        svg.appendChild(hline);
      });

      // winner path & bottom label (only after reveal)
      if (state.revealed && state.winnerTop != null) {
        const poly = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
        const pts = state.paths[state.winnerTop].points.map(p => p.join(',')).join(' ');
        poly.setAttribute('points', pts);
        poly.setAttribute('fill', 'none');
        poly.setAttribute('stroke', '#ef4444');
        poly.setAttribute('stroke-width', '5');
        poly.setAttribute('stroke-linejoin', 'round');
        poly.setAttribute('stroke-linecap', 'round');
        svg.appendChild(poly);

        // bottom "当たり"
        if (state.winBottom != null) {
          const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          text.setAttribute('x', state.colXs[state.winBottom]);
          text.setAttribute('y', bottomY + 24);
          text.setAttribute('text-anchor', 'middle');
          text.setAttribute('font-size', '12');
          text.setAttribute('fill', '#ef4444');
          text.textContent = '当たり';
          svg.appendChild(text);
        }
      }
    }

    function renderInputs() {
      const wrap = document.getElementById('inputs');
      wrap.innerHTML = '';
      state.colXs.forEach((_, i) => {
        const div = document.createElement('div');
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = `名前${i+1}`;
        input.value = state.names[i] || '';
        input.addEventListener('input', (e) => {
          state.names[i] = e.target.value;
          renderSVG();
        });
        div.appendChild(input);
        wrap.appendChild(div);
      });
    }

    function recomputePaths() {
      state.paths = state.colXs.map((_, i) => tracePath(i, state.rungs, state.colXs));
    }

    function handleGenerate() {
      const n = parseInt(document.getElementById('num').value || '0', 10);
      if (!Number.isFinite(n) || n < 2) { alert('人数は2人以上にしてください。'); return; }
      state.numPlayers = clamp(n, 2, 16);
      const margin = 80, usable = width - margin * 2;
      const gap = state.numPlayers > 1 ? usable / (state.numPlayers - 1) : 0;
      state.colXs = Array.from({length: state.numPlayers}, (_, i) => margin + i * gap);
      state.rungs = generateRungs(state.numPlayers, bottomY - topY);
      state.winBottom = Math.floor(Math.random() * state.numPlayers);
      state.revealed = false;
      state.winnerTop = null;
      state.generated = true;
      if (state.names.length < state.numPlayers) {
        for (let i = state.names.length; i < state.numPlayers; i++) state.names[i] = '';
      } else {
        state.names.length = state.numPlayers;
      }
      document.getElementById('hint').style.display = 'none';
      document.getElementById('stage').style.display = '';
      document.getElementById('reveal').disabled = false;
      document.getElementById('winLabel').style.display = 'none';
      renderInputs();
      recomputePaths();
      renderSVG();
    }

    function handleReveal() {
      if (!state.generated || state.winBottom == null) return;
      const idx = state.paths.findIndex(p => p.endCol === state.winBottom);
      state.winnerTop = idx >= 0 ? idx : null;
      state.revealed = true;
      renderSVG();
      const wl = document.getElementById('winLabel');
      wl.textContent = state.winnerTop != null ? `当たり：${state.names[state.winnerTop] || '参加者' + (state.winnerTop+1)}` : '当たり：—';
      wl.style.display = '';
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      document.getElementById('reveal').disabled = true;
    }

    document.getElementById('gen').addEventListener('click', handleGenerate);
    document.getElementById('reveal').addEventListener('click', handleReveal);
  </script>
</body>
</html>
