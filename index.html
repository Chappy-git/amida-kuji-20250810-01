<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>あみだくじ</title>
<meta name="theme-color" content="#111827" />
<link rel="manifest" href="manifest.json" />
<link rel="icon" sizes="192x192" href="icons/icon-192.png">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
html, body { margin:0; padding:0; background:#f8fafc; color:#0f172a; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial, sans-serif; overflow-x:hidden; }
.container { max-width:1000px; margin:24px auto; padding:16px; }
.card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,.05); padding:16px; overflow:hidden; }
.h1 { font-size:22px; font-weight:800; margin:0 0 12px; letter-spacing:.02em; }
.row { display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; margin-bottom:12px; }
.label { font-size:12px; margin-bottom:4px; display:block; color:#334155; }
input[type=tel], input[type=text] { border:1px solid #cbd5e1; border-radius:10px; padding:10px 12px; outline:none; font-size:16px; }
input[type=text] { width:140px; }
.btn { border:0; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; font-size:16px; }
.btn-primary { background:#111827; color:#fff; } .btn-primary:hover { opacity:.9; }
.btn-blue { background:#2563eb; color:#fff; } .btn-blue:disabled { opacity:.5; cursor:not-allowed; }
.muted { color:#64748b; font-size:12px; }
.stage { margin-top:16px; }

/* Responsive SVG holder (keeps 900x520 ratio) */
.svg-holder{ position:relative; width:100%; max-width:100%; }
.svg-spacer{ width:100%; padding-top:57.7777%; } /* 520/900*100 */
.svg-abs{ position:absolute; inset:0; }
svg{ display:block; width:100%; height:100%; }

/* Name inputs overlay */
.top-inputs{ position:absolute; left:0; right:0; top:6px; z-index:3; pointer-events:none; }
.top-inputs .name-wrap{ position:absolute; transform:translateX(-50%); }
.top-inputs input{ background:#fff; width:100%; pointer-events:auto; }

@media (max-width:600px) {
  .container { margin:0 auto; padding:8px; }
  .h1 { font-size:20px; }
}
.version{ color:#94a3b8; font-size:11px; margin-left:8px; }
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1 class="h1">あみだくじ <span class="version">v 2025-08-11-vanilla2</span></h1>
      <div class="row">
        <div>
          <label class="label">人数</label>
          <input id="numInput" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="2〜16" value="5" />
        </div>
        <button id="genBtn" class="btn btn-primary">生成</button>
        <button id="revealBtn" class="btn btn-blue" disabled>結果発表</button>
        <span id="winLabel" class="version" style="display:none;"></span>
      </div>

      <p id="hint" class="muted">人数を入力して「生成」を押してください。各列の上で名前を入力できます。</p>

      <div class="stage">
        <div class="svg-holder">
          <div class="svg-spacer"></div>
          <div class="svg-abs">
            <svg id="svg" viewBox="0 0 900 520" preserveAspectRatio="xMidYMid meet"></svg>
          </div>
          <div id="topInputs" class="top-inputs" aria-label="参加者名入力欄"></div>
        </div>
      </div>

      <div class="muted" style="margin-top:10px;">右上の「三」メニューから <a href="./reset.html">キャッシュを初期化</a> できます。</div>
    </div>
  </div>

<script>
(function(){
  'use strict';
  const W=900,H=520, topY=40, bottomY=H-40;
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

  // State
  let num=5;
  let numInputStr='5';
  let generated=false;
  let names=[];
  let rungs=[];
  let winBottom=null;
  let revealed=false;
  let winnerTop=null;

  // Elements
  const numInputEl = document.getElementById('numInput');
  const genBtn = document.getElementById('genBtn');
  const revealBtn = document.getElementById('revealBtn');
  const winLabel = document.getElementById('winLabel');
  const svg = document.getElementById('svg');
  const topInputs = document.getElementById('topInputs');
  const hint = document.getElementById('hint');

  // Numeric input handling
  numInputEl.addEventListener('input', (e)=>{
    const only=(e.target.value||'').replace(/\D/g,'');
    numInputStr = only;
    numInputEl.value = only;
  });
  numInputEl.addEventListener('blur', ()=>{ commitClamp(); });

  function commitClamp(){
    const parsed = parseInt(numInputStr||'0',10);
    const v = clamp(Number.isFinite(parsed)?parsed:0,2,16);
    num = v;
    numInputStr = String(v);
    numInputEl.value = numInputStr;
  }

  function generateRungs(numPlayers, height){
    const out=[];
    const minGap=28;
    const pairs=numPlayers-1;
    const baseCount = clamp(Math.round(height/120), 2, 7);
    for(let p=0;p<pairs;p++){
      const count = baseCount + Math.floor(Math.random()*2);
      const ys=[];
      for(let i=0;i<count;i++){
        let tries=0;
        while(tries<40){
          const y = topY + Math.random()*(height - 80) + 40; // 40..height-40 within ladder
          if(ys.every(yy=>Math.abs(yy-y)>=minGap)){
            const neighborLeft  = out.filter(r=>r.leftCol===p-1);
            const neighborRight = out.filter(r=>r.leftCol===p+1);
            const nearNeighbor = [...neighborLeft, ...neighborRight].some(r=>Math.abs(r.y-y) < minGap*0.7);
            if(!nearNeighbor){ ys.push(y); out.push({leftCol:p, y}); break; }
          }
          tries++;
        }
      }
    }
    out.sort((a,b)=>a.y-b.y);
    return out;
  }

  function tracePath(startCol, rungs, colXs){
    let col = startCol;
    let y = topY;
    const pts = [[colXs[col], y]];
    for(const rung of rungs){
      if(rung.leftCol===col || rung.leftCol===col-1){
        const goingDown = rung.y > y;
        const isOnLeft = rung.leftCol===col;
        const isOnRight = rung.leftCol===col-1;
        if(goingDown && (isOnLeft || isOnRight)){
          pts.push([colXs[col], rung.y]);
          col = isOnLeft ? col+1 : col-1;
          pts.push([colXs[col], rung.y]);
          y = rung.y;
        }
      }
    }
    pts.push([colXs[col], bottomY]);
    return { points: pts, endCol: col };
  }

  function getMargin(){
    return (window.innerWidth < 600) ? 40 : 80; // tighter on mobile
  }
  function getColXs(n){
    const margin = getMargin();
    const usable = W - margin*2;
    const gap = n>1 ? usable/(n-1) : 0;
    return Array.from({length:n}, (_,i)=> margin + i*gap);
  }

  function clearSvg(){
    while(svg.firstChild) svg.removeChild(svg.firstChild);
  }

  function render(){
    clearSvg();
    const colXs = getColXs(num);

    // vertical lines
    for(let i=0;i<colXs.length;i++){
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1', colXs[i]); line.setAttribute('y1', topY);
      line.setAttribute('x2', colXs[i]); line.setAttribute('y2', bottomY);
      line.setAttribute('stroke', '#111'); line.setAttribute('stroke-width','2');
      svg.appendChild(line);
    }
    // rungs
    for(let i=0;i<rungs.length;i++){
      const r = rungs[i];
      const hline = document.createElementNS('http://www.w3.org/2000/svg','line');
      hline.setAttribute('x1', colXs[r.leftCol]); hline.setAttribute('y1', r.y);
      hline.setAttribute('x2', colXs[r.leftCol+1]); hline.setAttribute('y2', r.y);
      hline.setAttribute('stroke', '#111'); hline.setAttribute('stroke-width','3');
      svg.appendChild(hline);
    }
    // names (top)
    for(let i=0;i<colXs.length;i++){
      const t = document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x', colXs[i]); t.setAttribute('y', 30); t.setAttribute('text-anchor','middle');
      t.setAttribute('font-size','12'); t.setAttribute('fill','#111');
      t.textContent = names[i] || `参加者${i+1}`;
      svg.appendChild(t);
    }
    // winner path
    if(revealed && winnerTop!=null){
      const allPaths = colXs.map((_,i)=> tracePath(i, rungs, colXs));
      const info = allPaths[winnerTop];
      const pts = info.points.map(p=>p.join(',')).join(' ');
      const poly = document.createElementNS('http://www.w3.org/2000/svg','polyline');
      poly.setAttribute('points', pts); poly.setAttribute('fill','none');
      poly.setAttribute('stroke','#ef4444'); poly.setAttribute('stroke-width','5');
      poly.setAttribute('stroke-linejoin','round'); poly.setAttribute('stroke-linecap','round');
      svg.appendChild(poly);

      if(winBottom!=null){
        const bt = document.createElementNS('http://www.w3.org/2000/svg','text');
        bt.setAttribute('x', colXs[winBottom]); bt.setAttribute('y', bottomY + 24);
        bt.setAttribute('text-anchor','middle'); bt.setAttribute('font-size','12'); bt.setAttribute('fill','#ef4444');
        bt.textContent = '当たり';
        svg.appendChild(bt);
      }
    }

    // overlay name inputs
    topInputs.innerHTML = '';
    // width based on number of players, clamped
    const nameWidthVw = clamp(Math.round((100/num)*0.7), 12, 22);
    const leftClampMin = nameWidthVw/2 + 2;
    const leftClampMax = 100 - nameWidthVw/2 - 2;
    for(let i=0;i<colXs.length;i++){
      const x = colXs[i];
      const leftPctRaw = x / W * 100;
      const leftPct = clamp(leftPctRaw, leftClampMin, leftClampMax);

      const wrap = document.createElement('div');
      wrap.className = 'name-wrap';
      wrap.style.left = leftPct + '%';
      wrap.style.width = nameWidthVw + 'vw';

      const inp = document.createElement('input');
      inp.type = 'text';
      inp.autocomplete = 'off';
      inp.placeholder = '名前' + (i+1);
      inp.setAttribute('aria-label', '参加者'+(i+1)+'の名前');
      inp.value = names[i] || '';
      inp.addEventListener('input', (e)=>{
        names[i] = e.target.value;
        render(); // keep simple and robust
      });

      wrap.appendChild(inp);
      topInputs.appendChild(wrap);
    }
  }

  function onGenerate(){
    commitClamp();
    if(num < 2){ alert('人数は2人以上にしてください。'); return; }
    names.length = num;
    for(let i=0;i<num;i++){ if(names[i]==null) names[i] = ''; }
    rungs = generateRungs(num, bottomY - topY);
    winBottom = Math.floor(Math.random() * num);
    revealed = false; winnerTop = null;
    generated = true;
    revealBtn.disabled = false;
    hint.style.display = 'none';
    winLabel.style.display = 'none';
    render();
  }

  function onReveal(){
    if(!generated || winBottom==null) return;
    const colXs = getColXs(num);
    const all = colXs.map((_,i)=> tracePath(i, rungs, colXs));
    const idx = all.findIndex(p=>p.endCol === winBottom);
    winnerTop = (idx>=0 ? idx : null);
    revealed = true;
    const winnerName = (winnerTop!=null ? (names[winnerTop] || ('参加者'+(winnerTop+1))) : '');
    winLabel.textContent = winnerName ? ('当たり：' + winnerName) : '当たり';
    winLabel.style.display = 'inline';
    revealBtn.disabled = true;
    render();
    setTimeout(()=>{ window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' }); }, 30);
  }

  document.getElementById('genBtn').addEventListener('click', onGenerate);
  document.getElementById('revealBtn').addEventListener('click', onReveal);
  window.addEventListener('resize', ()=>{ if(generated) render(); });

  // initial render (empty scaffold)
  render();

  // SW
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('sw.js');
    });
  }
})();
</script>
</body>
</html>
